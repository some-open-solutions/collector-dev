<!--
    Collector (Garcia, Kornell, Kerr, Blake & Haffey)
    A program for running experiments on the web
    Copyright 2012-2016 Mikey Garcia & Nate Kornell


    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License version 3 as published by
    the Free Software Foundation.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>

		Kitten release (2019) author: Dr. Anthony Haffey (team@someopen.solutions)
-->
<style>
.logo{
	height:30px;
	width:30px;
}
#collector_logo,
#github_logo{
  display:none;
}
</style>
<table id="logout_table">
	<tr>
		<td>
			<a href="" id="authlink" class="button" style="display:none">Authenticate Dropbox</a>
			<span id="dropbox_account_email" class="account_info text-white">No dropbox account linked yet</span>
		</td>

		<td>
			<img class='logo' style="border-radius: 50%; background-color:white; padding:2px" src="../logos/dbx.ico.png" id="dropbox_logo">
		</td>
    <td>
      <span id="save_status" class="text-white"></span>
    </td>
		<td>
			<img class='logo' style="border-radius: 50%; background-color:white; padding:2px" src="../logos/collector.ico.png" id="collector_logo">
		</td>
    <td>
			<img class='logo' style="border-radius: 50%; background-color:white; padding:2px" src="../logos/Github.png" id="github_logo">
		</td>
	</tr>
</table>

<script>

switch(Collector.detect_context()){

  case "localhost":
    //show the github icon
    $("#github_logo").show();
		$("#collector_logo").show();
    break;
	case "github":
  case "server":
    $("#collector_logo").show();
    break;
  default:
    $("#collector_logo").show(); //this might be redundant
    break;
};


function highlight_account(element_id){
  $("#" + element_id).animate(
    {
      fontSize:"20px"
    },
    {
      duration:1000,
      complete:function(){
        $("#"+element_id).animate(
          {
            fontSize:"0px"
          },
          {
            duration:1000
          }
        );
      }
    }
  );
}

$(".logo").hover(function(){
  var account_id = this.id.replace("logo","account_email");
  $("#"+account_id).show(500);
	$("#"+account_id).animate({
    fontSize:"14px"
  },500);
},function(){
  var account_id = this.id.replace("logo","account_email");
  $("#"+account_id).animate({
    fontSize:"0px"
  },500);
});

$("#collector_logo").on("click", function(){
	update_server_table();
	$("#login_modal").fadeIn();
});

$("#github_logo").on("click",function(){
	if(typeof(master_json.github) == "undefined"){
    master_json.github = {}
	}
  if(typeof(master_json.github.organisation) == "undefined"){
    master_json.github.organisation = "";
  }

  var dialog = bootbox.dialog({
    title: 'Synch with github repository',
    message: '<div class="jumbotron">' +
                '<h1 class="display-4">Collector</h1>' +
                '<p class="lead">Put in the information below to allow you to update your online experiments</p>' +
                '<div class="input-group mb-3">'+
                  '<div class="input-group-prepend">'+
                   ' <span class="input-group-text bg-primary text-white">Organisation</span>' +
                  '</div>' +
                  '<input class="form-control" id="github_organisation"/>' +
                '</div>' +
                '<div class="input-group mb-3">' +
                  '<div class="input-group-prepend">' +
                    '<span class="input-group-text bg-primary text-white">Repository\'s name</span>' +
                  '</div>' +
                  '<input class="form-control" id="github_repository"/>' +
                '</div>' +
              '</div>' +
              '<script>' +
                '$("#github_organisation").val(master_json.github.organisation);' +
                '$("#github_repository").val(master_json.github.repository);' +

                '$("#github_repository").on("keyup",function(){' +
                  'master_json.github.repository = $("#github_repository").val();' +
                '});' +
                '$("#github_organisation").on("keyup",function(){' +
                  'master_json.github.organisation = $("#github_organisation").val();' +
                '});' +
              '</' + 'script>',
    buttons: {
      AddToken:{
        label: "Add Token",
				className: 'btn-primary',
				callback: function(){
          bootbox.prompt("Please copy and paste the authentication token you generated by going <a href='https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token' target='_blank'>here</a>", function(auth_token){
            Collector.electron.git.add_token(auth_token);
          });

        }
      },
      Create:{
        label: "Create Repo",
				className: 'btn-primary',
				callback: function(){
          var github_organisation = $("#github_organisation").val();
          var github_repository = $("#github_repository").val()
          bootbox.alert(


            "Feel free to get a coffee while we set up your github repository <br><br>" +
      "<table style='margin:10px'>" +

        /*
        * create online repository
        */

        "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="create_repo_online_repo_input">' +
          "</td>" +
          "<td>" +
            "<div id='create_repo_online_repo_div'>Creating your online repository</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="create_repo_online_repo_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
        "</tr>" +

        /*
        * create linked online folder for repository
        */
        "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="link_online_repo_input">' +
          "</td>" +
          "<td>" +
            "<div id='link_online_repo_div'>Linking your online repository to a local version.</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="link_online_repo_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
        "</tr>" +

        /*
        * download Collector into the created folder
        */
        "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="download_collector_input">' +
          "</td>" +
          "<td>" +
            "<div id='download_collector_div'>Downloading Collector for your repository. (this can take 1-2 minutes)</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="download_collector_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
        "</tr>" +

        /*
        * push this folder to your online repository
        */
        "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="push_repo_input">' +
          "</td>" +
          "<td>" +
            "<div id='push_repo_div'>Pushing everything to your online repo. (this can take 5+ minutes ths first time)</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="push_repo_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
        "</tr>" +

        /*
        * Make your online repo a github pages website
        */
        "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="github_pages_input">' +
          "</td>" +
          "<td>" +
            "<div id='github_pages_div'>Activating your repository as a website you can direct participants to.</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="github_pages_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
        "</tr>" +

        "</table>"
      );


          // lazy way for bootbox alert appear at the start
          setTimeout(function(){
            response = Collector.electron.git.init({
              "organisation" : github_organisation,
              "repository"   : github_repository
            });
            if(response == "auth token missing"){
              bootbox.prompt("Please can you create a token <a href='https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token'>here</a> and paste it below:",function(auth_code){
                Collector.electron.git.add_token(auth_token);
              });
            } else if(response == "success") {
              $("#create_repo_online_repo_input").attr("checked",true);
              $("#create_repo_online_repo_div").addClass("text-primary");
              $("#create_repo_online_repo_spinner").hide();
              setTimeout(function(){
                local_repo_response = Collector
                                        .electron
                                        .git
                                        .local_repo({
                  "organisation": github_organisation,
                  "repository"  : github_repository
                });
                $("#link_online_repo_input").attr("checked",true);
                $("#link_online_repo_div").addClass("text-primary");
                $("#link_online_repo_spinner").hide();
                setTimeout(function(){
                  if(local_repo_response == "success"){
                    //$("#git_init_progress").html("downloading collector.");
                    var download_response = Collector
                                          .electron
                                          .git
                                          .download_collector({
                      "organisation" : github_organisation,
                      "repository"   : github_repository
                    });
                    $("#download_collector_input").attr("checked",true);
                    $("#download_collector_div").addClass("text-primary");
                    $("#download_collector_spinner").hide();
                    setTimeout(function(){
                      var push_response = Collector
                                            .electron
                                            .git
                                            .push({
                        "organisation" : github_organisation,
                        "repository"   : github_repository
                      });
                      $("#push_repo_input").attr("checked",true);
                      $("#push_repo_div").addClass("text-primary");
                      $("#push_repo_spinner").hide();

                      /*
                      * push response doesn't == success at,
                      */

                      setTimeout(function(){
                        var pages_response = Collector
                                              .electron
                                              .git
                                              .pages({
                          "organisation" : github_organisation,
                          "repository"   : github_repository
                        });
                        $("#github_pages_input").attr("checked",true);
                        $("#github_pages_div").addClass("text-primary");
                        $("#github_pages_spinner").hide();
                        bootbox.alert("page_response =" + pages_response);
                      });

                    },500);
                  }
                },500);
              });
            }
          },500);
        }
      },
			Pull: {
				label: "Pull",
				className: 'btn-primary',
				callback: function(){
					var organisation = $("#github_organisation").val();
					var repository   = $("#github_repository").val();

					eel.pull_collector(username,
														 organisation,
														 repository);

				}
			},
			Push: {
        label: "Push",
        className: 'btn-primary',
        callback: function(){
          var organisation = $("#github_organisation").val();
          var repository   = $("#github_repository").val();

          bootbox.alert(
            "Pushing to your repository<br><br>" +
          "<table style='margin:10px'>" +

          /*
          * updating the User folder in the repository
          */

          "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="update_local_repo_input">' +
          "</td>" +
          "<td>" +
            "<div id='update_local_repo_div'>Updating your local version of the repository</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="update_local_repo_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
          "</tr>" +


          /*
          * upload to the online repo
          */
          "<tr>" +
          "<td>" +
            '<input class="form-check-input" type="checkbox" value="" id="push_repo_online_input">' +
          "</td>" +
          "<td>" +
            "<div id='push_repo_online_div'>Push your changes to your online repository</div>" +
          "</td>" +
          "<td>" +
            '<span class="spinner-border text-primary" role="status" id="push_repo_online_spinner">' +
              '<span class="sr-only">Loading...</span>' +
            '</span>' +
          "</td>" +
          "</tr>" +

          "</table>"
          );

          bootbox.prompt(
            "Please describe this commit:",
            function(message){
              setTimeout(function(){
                // copy changes
                Collector.electron.git.add_changes({
                  "organisation" : organisation,
                  "repository"   : repository
                });
                $("#update_local_repo_input").attr(
                  "checked",
                  true
                );
                $("#update_local_repo_div").addClass(
                  "text-primary"
                );
                $("#update_local_repo_spinner").hide();

                setTimeout(function(){
                  /*
                  * commit and push changes
                  */
                  Collector.electron.git.push({
                    "organisation" : organisation,
                    "repository"   : repository,
                    "message"      : message
                  });
                  $("#push_repo_online_input").attr(
                    "checked",
                    true
                  );
                  $("#push_repo_online_div").addClass(
                    "text-primary"
                  );
                  $("#push_repo_online_spinner").hide();
                },500);
              },500);

          });

          // lazy way for bootbox alert appear at the start

        }
      },
      view: {
        label: "Github",
        className: 'btn-primary',
        callback: function(){
          var organisation = $("#github_organisation").val();
          var repository   = $("#github_repository").val();

          if(organisation == ""){
            organisation = username;
          }
          window.open('https://www.github.com/' +
                      organisation +
                      '/' +
                      repository,'_blank');
        }
      },
      cancel: {
        label: "Cancel",
        className: 'btn-secondary',
        callback: function(){
          //nothing, just close
        }
      }
    }
  });
});

$("#dropbox_logo").on("click", function(){
	var dialog = bootbox.dialog({
	title: 'Dropbox account',
	message: "<p>Do you want to choose (another) dropbox account or view your dropbox files? <br><br> <b>NOTE</b>: Before logging out, make sure you have saved everything you want to.</p>",
	buttons: {
		cancel: {
			label: "View",
			className: 'btn-primary',
			callback: function(){
				window.open('https://www.dropbox.com/home/Apps/Collector-SOS','_blank');
			}
		},
		noclose: {
			label: "Select Account",
			className: 'btn-info',
			callback: function(){
				force_reauth_dbx();
			}
		},
		ok: {
			label: "Cancel",
			className: 'btn-secondary',
		}
	}
	});
});
</script>
<script src="DropboxInitiate.js"></script>
